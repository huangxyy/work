name: Deploy

on:
  workflow_dispatch:
    inputs:
      branch:
        description: Branch to deploy
        required: false
        default: main
      run_migrations:
        description: Run prisma migrate deploy
        required: false
        type: boolean
        default: true
  workflow_run:
    workflows:
      - CI
    types:
      - completed

concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  deploy:
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.event == 'push' &&
       github.event.workflow_run.head_branch == 'main')
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Resolve deploy parameters
        id: params
        run: |
          set -euo pipefail
          branch="main"
          run_migrations="1"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "${{ inputs.branch }}" ]; then
              branch="${{ inputs.branch }}"
            fi
            if [ "${{ inputs.run_migrations }}" = "false" ]; then
              run_migrations="0"
            fi
          else
            branch="${{ github.event.workflow_run.head_branch }}"
          fi

          echo "branch=${branch}" >> "$GITHUB_OUTPUT"
          echo "run_migrations=${run_migrations}" >> "$GITHUB_OUTPUT"

      - name: Validate required secrets
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          set -euo pipefail
          for key in DEPLOY_HOST DEPLOY_USER DEPLOY_SSH_KEY; do
            if [ -z "${!key}" ]; then
              echo "Missing secret: ${key}" >&2
              exit 1
            fi
          done

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Add server to known_hosts
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
        run: |
          set -euo pipefail
          port="${DEPLOY_PORT:-22}"
          mkdir -p ~/.ssh
          ssh-keyscan -p "${port}" "${DEPLOY_HOST}" >> ~/.ssh/known_hosts

      - name: Run remote deployment
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_APP_DIR: ${{ secrets.DEPLOY_APP_DIR }}
          BRANCH: ${{ steps.params.outputs.branch }}
          RUN_MIGRATIONS: ${{ steps.params.outputs.run_migrations }}
        run: |
          set -euo pipefail
          port="${DEPLOY_PORT:-22}"
          app_dir="${DEPLOY_APP_DIR:-/www/homework-ai}"

          ssh -p "${port}" "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "APP_DIR='${app_dir}' BRANCH='${BRANCH}' RUN_MIGRATIONS='${RUN_MIGRATIONS}' bash '${app_dir}/deploy/update-host.sh'"
