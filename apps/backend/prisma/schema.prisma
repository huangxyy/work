generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  STUDENT
  TEACHER
  ADMIN
}

enum SubmissionStatus {
  QUEUED
  PROCESSING
  DONE
  FAILED
}

model User {
  id           String   @id @default(cuid())
  role         Role
  name         String
  account      String   @unique
  passwordHash String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  teacherClasses Class[]      @relation("TeacherClasses")
  studentEnrolls Enrollment[]
  submissions    Submission[]
  batchUploads   BatchUpload[]
}

model Class {
  id        String   @id @default(cuid())
  name      String
  grade     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  teachers      User[]          @relation("TeacherClasses")
  enrolls       Enrollment[]
  homeworks     Homework[]
  gradingPolicy GradingPolicy? @relation("ClassGradingPolicy")
}

model Enrollment {
  id        String   @id @default(cuid())
  classId   String
  studentId String
  createdAt DateTime @default(now())

  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  student User  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId])
  @@index([classId])
  @@index([studentId])
}

model Homework {
  id        String   @id @default(cuid())
  classId   String
  title     String
  desc      String?
  dueAt     DateTime?
  createdAt DateTime @default(now())

  class         Class          @relation(fields: [classId], references: [id], onDelete: Cascade)
  submissions   Submission[]
  batchUploads  BatchUpload[]
  gradingPolicy GradingPolicy? @relation("HomeworkGradingPolicy")

  @@index([classId])
}

model Submission {
  id         String           @id @default(cuid())
  homeworkId String
  studentId  String
  batchId    String?
  status     SubmissionStatus @default(QUEUED)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  images     SubmissionImage[]
  ocrText    String?          @db.Text
  gradingJson Json?
  totalScore Float?
  errorCode  String?
  errorMsg   String?

  homework Homework @relation(fields: [homeworkId], references: [id], onDelete: Cascade)
  student  User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  batch    BatchUpload? @relation(fields: [batchId], references: [id], onDelete: SetNull)

  @@index([homeworkId])
  @@index([studentId])
  @@index([status])
  @@index([batchId])
  @@index([createdAt])
  @@index([homeworkId, status])
  @@index([studentId, homeworkId])
}

model BatchUpload {
  id                 String   @id @default(cuid())
  homeworkId         String
  uploaderId         String
  totalImages        Int
  matchedImages      Int
  unmatchedCount     Int
  createdSubmissions Int
  skipped            Json?
  mode               String?
  needRewrite        Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  homework   Homework    @relation(fields: [homeworkId], references: [id], onDelete: Cascade)
  uploader   User        @relation(fields: [uploaderId], references: [id], onDelete: Cascade)
  submissions Submission[]

  @@index([homeworkId])
  @@index([uploaderId])
}

model SubmissionImage {
  id           String   @id @default(cuid())
  submissionId String
  objectKey    String
  createdAt    DateTime @default(now())

  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
}

model SystemConfig {
  key       String   @id
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LlmCallLog {
  id               String   @id @default(cuid())
  source           String
  providerId       String?
  providerName     String?
  model            String?
  status           String
  latencyMs        Int?
  promptTokens     Int?
  completionTokens Int?
  totalTokens      Int?
  cost             Float?
  prompt           String?  @db.Text
  systemPrompt     String?  @db.Text
  response         String?  @db.Text
  error            String?  @db.Text
  userId           String?
  submissionId     String?
  createdAt        DateTime @default(now())
  meta             Json?

  @@index([createdAt])
  @@index([source])
  @@index([providerId])
  @@index([status])
}

model GradingPolicy {
  id         String   @id @default(cuid())
  classId    String?  @unique
  homeworkId String?  @unique
  mode       String?
  needRewrite Boolean?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  class    Class?    @relation("ClassGradingPolicy", fields: [classId], references: [id], onDelete: Cascade)
  homework Homework? @relation("HomeworkGradingPolicy", fields: [homeworkId], references: [id], onDelete: Cascade)

  @@index([classId])
  @@index([homeworkId])
}
