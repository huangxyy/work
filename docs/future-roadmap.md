# 未来开发清单（平台化与多学校部署）

本清单面向“单校稳定运行 → 多校平台化”的演进路径，适配以下已确认的前提：

- 子域名模式：`{school}.homework-ai.local`
- 每校独立数据库用户
- 平台后台独立部署，统一管理多学校

## Phase 0（当前单校稳态）

目标：保持单校稳定交付，不引入架构性风险。

- [ ] 完善单校部署文档（Docker 依赖 + 本地前后端 + Nginx 代理）
- [ ] 统一配置入口（LLM/OCR/预算/留存策略）
- [ ] 关键功能稳定性提升（批量上传流式解压、队列监控、PDF 导出）
- [ ] 功能与权限全链路自测清单

## Phase 1（平台后台准备）

目标：构建平台控制面（不影响现有学校业务）。

- [ ] 平台后台服务 + 平台数据库
- [ ] School 基础信息管理（学校名、子域名、状态）
- [ ] SchoolDB 连接信息管理（dbName/dbUser/dbPass/dbHost/dbPort）
- [ ] 学校开通流程（建库 → 迁移 → 初始化管理员）
- [ ] 平台审计日志（开通/停用/配置变更）

## Phase 2（子域名路由 + 多库动态连接）

目标：通过子域名自动路由到学校数据库。

- [ ] 解析 Host → schoolId
- [ ] 动态 Prisma Client 连接池（按 schoolId 缓存 + TTL 回收）
- [ ] 请求级上下文注入 schoolId
- [ ] 禁止跨校访问（全链路拦截）

## Phase 3（多校队列与 Worker）

目标：任务队列按学校隔离，保证可观测性。

- [ ] 队列 payload 增加 schoolId
- [ ] Worker 基于 schoolId 连接对应数据库
- [ ] 队列监控支持按学校筛选
- [ ] 管理端“学校级队列”状态面板

## Phase 4（学校级配置与配额）

目标：每校独立配置/预算，平台统一监管。

- [ ] SystemConfig 下沉至学校数据库
- [ ] LLM/OCR/预算/日志留存/策略配置按校隔离
- [ ] 平台后台提供配置模板与继承

## Phase 5（运维与合规）

目标：可售交付与运维保障。

- [ ] 学校级备份/恢复
- [ ] 平台级健康监控（LLM/OCR/队列/存储）
- [ ] 操作审计与访问日志
- [ ] 账号批量导入/导出

## 交付形态（本地部署建议）

- Nginx 负责子域名反代：`{school}.homework-ai.local`
- 平台后台独立域名：`platform.homework-ai.local`
- 学校后台统一服务实例（动态多库）
- OCR/LLM 走内网可配置地址

## 风险提示

- 动态多库连接需注意连接池与并发压力（建议 TTL + 上限）
- 多校队列必须携带 schoolId，避免跨校数据污染
- 备份/恢复需规范操作权限与审计
